---
title: "Mongoose Repositórios"
description: "Guia de integração dos repositórios Mongoose com as interfaces de domínio."
slug: "/docs/mongoose-repositories"
---

# Mongoose Repositories Integration Guide

> Os repositórios Mongoose são plugáveis e espelham as interfaces de domínio (`IUserRepository`, `IWalletRepository`, etc.). Esta página mostra como ativar a persistência Mongo, quais arquivos importar e como manter a paridade com as versões in-memory.

## Visão geral da arquitetura

1. **Domínio** define as interfaces (`src/core/**/domain/repositories/*`).
2. **Factories** (`src/infrastructure/persistence/factory.ts`) escolhem entre as implementações in-memory e Mongo lendo `USE_MONGOOSE_PERSISTENCE`.
3. **server.ts** conecta/desconecta o Mongo via `connectMongoDB()` / `disconnectMongoDB()` quando a flag está ativa.
4. **Casos de uso/rotas** apenas importam as factories; portanto, alternar entre memória e Mongo não exige mudança de código.

```
Domain (interfaces) → Persistence factory → Mongoose repo → Schema → MongoDB
```

## Matriz de repositórios

| Contexto | Interface | Implementação Mongo | Schema principal | Observações |
| --- | --- | --- | --- | --- |
| Usuários | `IUserRepository` | `src/infrastructure/persistence/mongoose/repositories/MongooseUserRepository.ts` | `schemas/UserSchema.ts` | Índices únicos em `email` e `username`; sincroniza IDs do Clerk. |
| Carteiras | `IWalletRepository` | `MongooseWalletRepository.ts` | `schemas/WalletSchema.ts` | Mantém `transactions[]` embutidas; usa projeções para histórico paginado. |
| Apostas | `IBetRepository` | `MongooseBetRepository.ts` | `schemas/BetSchema.ts` | Índices combinados por `status`, `userId`, `eventId`. |
| Eventos | `IEventRepository` | *(in-memory apenas)* | — | Planejado para futura coleção. |
| Pacotes de crédito | `ICreditPackageRepository` | `MongooseCreditPackageRepository.ts` | `schemas/CreditPackageSchema.ts` | Campos derivados (`bonusPercent`) calculados no domínio antes de persistir. |
| Solicitações de saque | `IWithdrawalRequestRepository` | `MongooseWithdrawalRequestRepository.ts` | `schemas/WithdrawalRequestSchema.ts` | Guarda audit trail (`approverId`, `approvedAt`). |

## Ativando/desativando Mongo

1. Defina no `.env`:
   ```properties
   USE_MONGOOSE_PERSISTENCE=true
   MONGODB_URI=mongodb://localhost:27017/backbet-dev
   MONGODB_DB_NAME=backbet-dev
   ```
2. Reinicie o servidor. `server.ts` conectará o Mongo antes de inicializar o `ApiServer` e registrará `SIGINT/SIGTERM` para `disconnectMongoDB()`.
3. `create<User|Wallet|Bet|...>Repository()` passará a importar os módulos Mongoose dinamicamente (lazy import evita carregar schemas quando a flag está falsa).
4. Para rodar em memória novamente, troque a flag para `false` e reinicie.

## Padrões de implementação

- **Mapeamento**: cada repositório possui helpers `toDomain` / `toPersistence`. Nunca manipule documentos diretamente na camada de aplicação.
- **Lean queries**: leituras usam `.lean({ virtuals: true })` para reduzir custo de hidratação.
- **Atualizações idempotentes**: `save()` aplica `findOneAndUpdate({ _id }, dto, { upsert: true })`, garantindo convergência com as regras do domínio.
- **Erro padronizado**: violações de índice ou falhas inesperadas são convertidas para `AppError` (`CONFLICT`, `INTERNAL_SERVER_ERROR`). Use `AppError.isAppError` ao tratar em casos de uso.
- **Data consistency**: timestamps (`createdAt`, `updatedAt`) são gerenciados pelo domínio; o schema apenas define defaults.

### Exemplo (User Repository)

```ts
const repo = await createUserRepository();

const user = User.create({
  email: new Email('user@example.com'),
  username: 'john_doe',
  status: 'ACTIVE',
});

await repo.save(user); // converte para schema e faz upsert

const fetched = await repo.findByEmail(user.email.value);
if (!fetched) {
  throw new AppError('NOT_FOUND', 'Usuário não encontrado', 404);
}
```

## Testes e ambientes

| Cenário | Recomendação |
| --- | --- |
| Unit tests de casos de uso | Use os repositórios in-memory (flag `false`). Mantém testes rápidos e determinísticos. |
| Integração/Mongo real | Suba Mongo com Docker ou Testcontainers, habilite a flag e rode `npm run test -- integration`. Limpe coleções com `dropDatabase()` antes de cada suite. |
| CI | Evite habilitar Mongo a menos que o pipeline suba um container. Sem URI válido, `env.ts` interrompe o processo em produção. |

## Índices e migrações

- Schemas em `src/infrastructure/persistence/mongoose/schemas/**/*` definem índices via `schema.index(...)`. O Mongoose sincroniza automaticamente quando o app sobe, mas valide com `db.<collection>.getIndexes()` em ambientes críticos.
- Mudanças grandes (novos campos obrigatórios, TTLs) devem vir acompanhadas de scripts em `scripts/migrations/<timestamp>.ts` ou instruções no runbook.
- Revisite `docs/MONGODB_SETUP.mdx` antes de mexer em índices para garantir que os ambientes estão configurados.

## Troubleshooting rápido

| Sintoma | Causa provável | Mitigação |
| --- | --- | --- |
| `MongoDB connection failed` no boot | URI incorreta ou instância off-line | Verifique `MONGODB_URI`, teste com `mongosh`, confira se o container está ativo. |
| `duplicate key error` ao salvar usuário/carteira | Índice único violado | Trate com `AppError('CONFLICT')`; execute `findByEmail`/`findByUserId` antes de salvar. |
| `/readiness` retorna `mongo: down` | Flag habilitada mas banco indisponível | Observe os logs `readiness_dependency` e confirme firewall/Network Access no Atlas. |
| `Topology was destroyed` em produção | Conexão foi encerrada abruptamente | Garanta `retryWrites=true` e que o cluster aceita keep-alive; reinicie o pod após instabilidades. |

## Checklist para novos repositórios

- [ ] Interface de domínio definida em `core/<context>/domain/repositories`.
- [ ] Schema criado em `infrastructure/persistence/mongoose/schemas` com índices explícitos.
- [ ] Implementação adicionada à factory em `persistence/factory.ts`.
- [ ] Testes cobrindo conversão domínio ↔ persistence.
- [ ] Documentação atualizada aqui e no `docs/MONGODB_SETUP.mdx` se novos env vars forem necessários.

## Referências

- `src/infrastructure/persistence/factory.ts`
- `src/infrastructure/persistence/mongoose/repositories/*`
- `docs/MONGODB_SETUP.mdx` (flags e provisionamento)
- [Mongoose docs](https://mongoosejs.com/docs/guide.html)
