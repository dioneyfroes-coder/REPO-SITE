---
title: "Mongoose Repositórios"
description: "Guia de integração dos repositórios Mongoose com as interfaces de domínio."
slug: "/docs/mongoose-repositories"
---

# Mongoose Repositories Integration Guide

Este guia explica como integrar os repositórios Mongoose à sua aplicação BackBet.

## Arquitetura

Os repositórios Mongoose implementam as mesmas interfaces que os repositórios em memória, facilitando a substituição:

```
Domain Layer (Interfaces)
  ↓
Infrastructure Layer (Mongoose Implementation)
  ↓
Persistence Layer (MongoDB)
```

## Repositórios Disponíveis

### 1. MongooseUserRepository

Implementa `IUserRepository` para persistência de usuários.

**Métodos:**
- `save(user: User): Promise` - Criar ou atualizar usuário
- `findById(id: string): Promise` - Buscar por ID
- `findByEmail(email: string): Promise` - Buscar por email
- `update(user: User): Promise` - Atualizar usuário existente

**Exemplo:**

```typescript

// Criar usuário
const user = new User({
  email: new Email('user@example.com'),
  username: 'john_doe',
  status: 'ACTIVE',
  createdAt: new Date(),
  updatedAt: new Date(),
}, 'user-id-123');

await userRepository.save(user);

// Buscar usuário
const foundUser = await userRepository.findById('user-id-123');
```

### 2. MongooseWalletRepository

Implementa `IWalletRepository` para persistência de carteiras e transações.

**Métodos:**
- `save(wallet: Wallet): Promise` - Criar carteira
- `findByUserId(userId: string): Promise` - Buscar carteira de usuário
- `update(wallet: Wallet): Promise` - Atualizar saldo
- `delete(userId: string): Promise` - Deletar carteira
- `getHistory(userId: string, limit?: number, offset?: number): Promise` - Histórico de transações

**Exemplo:**

```typescript

// Criar carteira
const wallet = new Wallet('user-id-123', 'BRL');
wallet.deposit(1000);
await walletRepository.save(wallet);

// Buscar carteira
const userWallet = await walletRepository.findByUserId('user-id-123');

// Histórico de transações
const { transactions, total } = await walletRepository.getHistory('user-id-123', 10, 0);
console.log(`Total de transações: ${total}`);
console.log(`Primeiras 10: ${transactions.length}`);
```

### 3. MongooseBetRepository

Implementa `IBetRepository` para persistência de apostas.

**Métodos:**
- `create(bet: Bet): Promise` - Criar aposta
- `update(bet: Bet): Promise` - Atualizar aposta
- `findById(id: string): Promise` - Buscar por ID
- `findByUserId(userId: string): Promise` - Apostas do usuário
- `findByEventId(eventId: string): Promise` - Apostas do evento
- `findByStatus(status: BetStatus): Promise` - Apostas por status
- `findAll(filter?: {...}): Promise` - Listar com filtros
- `exists(id: string): Promise` - Verificar existência
- `delete(id: string): Promise` - Deletar aposta

**Exemplo:**

```typescript

// Buscar apostas pendentes
const pendingBets = await betRepository.findByStatus('PENDING');

// Buscar apostas de um usuário
const userBets = await betRepository.findByUserId('user-id-123');

// Buscar com múltiplos filtros
const filteredBets = await betRepository.findAll({
  userId: 'user-id-123',
  status: 'WON',
});
```

## Integração com Dependency Injection

Se usar um padrão de DI, configure os repositórios da seguinte forma:

```typescript

}
```

## Factory Pattern para Persistência

Crie uma factory que escolha entre em-memória e Mongoose baseado em variável de ambiente:

```typescript

const USE_MONGOOSE = process.env.USE_MONGOOSE_PERSISTENCE === 'true';

}

}

}
```

Use na aplicação:

```typescript

const userRepository = createUserRepository();
const walletRepository = createWalletRepository();
const betRepository = createBetRepository();

// Usar normalmente - sem diferença de interface
```

## Esquemas MongoDB

Os seguintes esquemas estão disponíveis:

### User Schema

```typescript
  _id: ObjectId,
  email: string (unique),
  username: string (unique),
  firstName?: string,
  lastName?: string,
  status: 'PENDING_VERIFICATION' | 'ACTIVE' | 'SUSPENDED',
  createdAt: Date,
  updatedAt: Date
}
```

**Índices:**
- `email` (unique)
- `username` (unique)

### Wallet Schema

```typescript
  _id: ObjectId,
  userId: string (unique, indexed),
  balance: number (min: 0),
  lockedBalance: number (min: 0),
  currency: 'BRL' | 'USD' | 'EUR',
  transactions: [
    {
      id: string,
      type: 'DEPOSIT' | 'WITHDRAW' | 'LOCK' | 'UNLOCK',
      amount: number,
      description?: string,
      createdAt: Date
    }
  ],
  createdAt: Date,
  updatedAt: Date
}
```

**Índices:**
- `userId` (unique, indexed)
- `transactions.createdAt` (para queries rápidas de histórico)

### Bet Schema

```typescript
  _id: ObjectId,
  userId: string (indexed),
  eventId: string (indexed),
  marketId: string,
  oddId: string,
  amount: number (min: 0.01),
  odds: number (min: 1.0),
  potentialReturn: number,
  status: 'PENDING' | 'WON' | 'LOST' | 'CANCELED' (indexed),
  type: 'SINGLE' | 'MULTIPLE',
  currency: 'BRL' | 'USD' | 'EUR',
  resolvedAt?: Date,
  cancellationReason?: string,
  createdAt: Date,
  updatedAt: Date
}
```

**Índices:**
- `userId` (para queries por usuário)
- `eventId` (para queries por evento)
- `status` (para queries por status)
- `createdAt` (para ordenação por data)

## Tratamento de Erros

Todos os repositórios lançam `AppError` com códigos padronizados:

```typescript
  const user = await userRepository.findById('invalid-id');
  if (!user) {
    // Não encontrado - retorna null, não lança erro
  }
} catch (error) {
  if (error instanceof AppError) {
    console.error(`[${error.code}] ${error.message}`);
    // INTERNAL_SERVER_ERROR: Erro na conexão MongoDB
    // NOT_FOUND: Recurso não encontrado
    // CONFLICT: Violação de constraints (email/username duplicado)
  }
}
```

## Performance e Boas Práticas

### 1. Índices

Garanta que os índices estão criados:

```bash
> use backbet-dev
> db.users.getIndexes()
> db.wallets.getIndexes()
> db.bets.getIndexes()
```

### 2. Paginação

Para listas grandes, use pagination:

```typescript
const page = 1;
const pageSize = 20;
const skip = (page - 1) * pageSize;

const bets = await betRepository.findAll({
  userId: 'user-id-123',
  status: 'PENDING'
});
// Aplicar slice no cliente ou modify método com skip/limit
```

### 3. Lean Queries

Todas as queries usam `.lean()` para melhor performance em leitura:

```typescript
// Sem modificar a query de escrita
```

### 4. Transações (Futuro)

Para operações multi-documento:

```typescript
// await session.startTransaction();
// try {
//   await userRepository.save(user);
//   await walletRepository.save(wallet);
//   await session.commitTransaction();
// } catch (error) {
//   await session.abortTransaction();
// }
```

## Troubleshooting

### Erro: "MongoDB connection failed"

Verifique:
1. MongoDB está rodando: `mongod --dbpath /usr/local/var/mongodb`
2. MONGODB_URI correto no `.env`
3. Network access no MongoDB Atlas

### Erro: "duplicate key error"

Significa violação de índice único. Verifique:
- Email/username já existe (IUserRepository)
- UserId já tem carteira (IWalletRepository)

Use `findByEmail()` antes de criar novo usuário.

### Erro: "The MongoClient instance has been closed"

A conexão foi fechada. Verifique se `disconnectMongoDB()` foi chamado antes do tempo.

## Referências

- [Mongoose Documentation](https://mongoosejs.com/)
- [MongoDB Best Practices](https://docs.mongodb.com/manual/administration/production-checklist/)
-
