---
title: "Arquitetura BackBet"
description: "VisÃ£o geral da arquitetura, integraÃ§Ã£o e nÃºcleos de negÃ³cio do BackBet."
slug: "/docs/architecture"
---
# DomÃ­nio de NegÃ³cio - Arquitetura e IntegraÃ§Ã£o

## VisÃ£o Geral

A aplicaÃ§Ã£o Ã© estruturada em torno de **3 cores de negÃ³cio principais** (bounded contexts) que funcionam de forma integrada:

1. **User Core** - Gerencia usuÃ¡rios e autenticaÃ§Ã£o
2. **Finance Core** - Gerencia carteiras e operaÃ§Ãµes financeiras
3. **Betting Core** - Gerencia apostas e eventos

Todos compartilham abstraÃ§Ãµes comuns no **Shared Domain**.

## Cores de NegÃ³cio

### 1. User Core (`src/core/user/`)
**Responsabilidades:**
- Criar e gerenciar usuÃ¡rios
- AutenticaÃ§Ã£o e verificaÃ§Ã£o de identidade
- Gerenciar status do usuÃ¡rio (ACTIVE, SUSPENDED, PENDING_VERIFICATION)

**Entidades:**
- `User` - agregado raiz com email, username, status

**ServiÃ§os:**
- `UserService` - orquestra criaÃ§Ã£o, ativaÃ§Ã£o, suspensÃ£o

**RepositÃ³rios:**
- `IUserRepository` - contrato de persistÃªncia

**ImplementaÃ§Ãµes de PersistÃªncia:**
- `MongooseUserRepository` - implementaÃ§Ã£o MongoDB/Mongoose com:
  - Ãndices Ãºnicos em email e username
  - ValidaÃ§Ã£o de status (ACTIVE, SUSPENDED, PENDING_VERIFICATION)
  - MÃ©todos: save, findById, findByEmail, update
- `UserRepository` - implementaÃ§Ã£o in-memory (fallback para testes)

**Factory de RepositÃ³rios:**
- `createUserRepository()` - seleciona implementaÃ§Ã£o baseado em `USE_MONGOOSE_PERSISTENCE` env var

**IntegraÃ§Ã£o com outros cores:**
- Cria `Wallet` automaticamente ao registrar novo usuÃ¡rio
- Consulta carteira ao processar operaÃ§Ãµes financeiras

---

### 2. Finance Core (`src/core/finance/`)
**Responsabilidades:**
- Gerenciar carteiras de usuÃ¡rios
- Realizar depÃ³sitos e saques
- Bloquear fundos (lock/unlock) para reservas

**Entidades:**
- `Wallet` - agregado raiz com balance, lockedBalance, currency

**Value Objects:**
- `CurrencyValueObject` - valida moedas suportadas (BRL, USD, EUR)
- `Money` (em shared) - valor monetÃ¡rio com operaÃ§Ãµes

**ServiÃ§os:**
- `WalletService` - orquestra operaÃ§Ãµes financeiras

**RepositÃ³rios:**
- `IWalletRepository` - contrato de persistÃªncia

**ImplementaÃ§Ãµes de PersistÃªncia:**
- `MongooseWalletRepository` - implementaÃ§Ã£o MongoDB/Mongoose com:
  - Ãndice Ãºnico em userId
  - Subdocumento de transactions com histÃ³rico completo
  - MÃ©todos: save, findByUserId, update, getHistory, delete
  - ValidaÃ§Ã£o de currency (BRL, USD, EUR)
- `WalletRepository` - implementaÃ§Ã£o in-memory (fallback para testes)

**Factory de RepositÃ³rios:**
- `createWalletRepository()` - seleciona implementaÃ§Ã£o baseado em `USE_MONGOOSE_PERSISTENCE` env var

**IntegraÃ§Ã£o com outros cores:**
- Consultado por `BetService` ao colocar apostas
- Consultado por `BetService` ao resolver apostas
- Enriquecido com domÃ­nio de pagamentos futuro

---

### 3. Betting Core (`src/core/betting/`)
**Responsabilidades:**
- Gerenciar apostas de usuÃ¡rios
- Criar e gerenciar eventos esportivos
- Definir mercados e odds
- Resolver apostas

**Entidades:**
- `Bet` - agregado raiz de uma aposta (status: PENDING, WON, LOST, CANCELED)
- `Event` - agregado raiz de um evento esportivo
- `Market` - entidade dentro do agregado Event

**Value Objects:**
- `Odds` - cotaÃ§Ã£o de uma aposta (intervalo: (1, 1000])
- `BetAmount` - valor da aposta com validaÃ§Ãµes

**ServiÃ§os:**
- `BetService` - orquestra operaÃ§Ã£o de apostas

**RepositÃ³rios:**
- `IBetRepository` / `IEventRepository` - contratos de persistÃªncia

**ImplementaÃ§Ãµes de PersistÃªncia:**
- `MongooseBetRepository` - implementaÃ§Ã£o MongoDB/Mongoose com:
  - Ãndices em userId, eventId, status para queries otimizadas
  - Subdocumento de resolution (result, resolvedAt, resolvedBy)
  - MÃ©todos: create, update, findById, findByUserId, findByEvent, delete
  - ValidaÃ§Ã£o de status (PENDING, WON, LOST, CANCELED)
- `BetRepository` / `EventRepository` - implementaÃ§Ãµes in-memory (fallback para testes)

**Factory de RepositÃ³rios:**
- `createBetRepository()` - seleciona implementaÃ§Ã£o baseado em `USE_MONGOOSE_PERSISTENCE` env var
- `createEventRepository()` - seleciona implementaÃ§Ã£o baseado em `USE_MONGOOSE_PERSISTENCE` env var

**IntegraÃ§Ã£o com outros cores:**
- Valida User no User Core
- Gerencia fundos via Finance Core

---

## 4. Shared Domain (`src/core/shared/`)

**RepositÃ³rios:**
- `IRepository<T>` - contrato genÃ©rico para CRUD

### Entidades Base
- `AggregateRoot` - classe abstrata com id, createdAt, updatedAt, version

### Value Objects Comuns
- `UniqueId` - gerador e validador de UUIDs
- `Money` - operaÃ§Ãµes monetÃ¡rias (add, subtract, multiply, compare)

### Tipos Compartilhados
- `SupportedCurrency` - 'BRL' | 'USD' | 'EUR'
- `ResourceStatus` - status genÃ©rico de recursos
- `DomainError` - estrutura de erros
- `Result` - padrÃ£o Result para retorno de operaÃ§Ãµes
- `PaginatedDTO` - resposta paginada padrÃ£o
- `FilterDTO` - filtros genÃ©ricos

---

## Infraestrutura de PersistÃªncia

### Factory Pattern (`src/infrastructure/persistence/factory.ts`)

 A aplicaÃ§Ã£o utiliza o **Factory Pattern** para permitir troca transparente entre implementaÃ§Ãµes de repositÃ³rios:

```typescript
// VariÃ¡vel de ambiente controla qual implementaÃ§Ã£o usar
USE_MONGOOSE_PERSISTENCE=true  // MongoDB/Mongoose
USE_MONGOOSE_PERSISTENCE=false // In-Memory

// Factory seleciona automaticamente
export async function createUserRepository(): Promise<IUserRepository> {
  if (process.env.USE_MONGOOSE_PERSISTENCE === 'true') {
    const { MongooseUserRepository } = await import('./mongoose/repositories/MongooseUserRepository');
    return new MongooseUserRepository();
  }
  return new UserRepository(); // fallback in-memory
}
```

**Vantagens:**
- Zero mudanÃ§a no cÃ³digo de domÃ­nio ao trocar persistÃªncia
- Testes podem usar in-memory para velocidade
- ProduÃ§Ã£o usa MongoDB para durabilidade
- Futuras implementaÃ§Ãµes (Redis, PostgreSQL) podem ser adicionadas facilmente

### MongoDB/Mongoose (`src/infrastructure/persistence/mongoose/`)

**Schemas:**
- `UserSchema.ts` - User com Ã­ndices Ãºnicos em email/username
- `WalletSchema.ts` - Wallet com Ã­ndice Ãºnico em userId e subdocumento transactions
- `BetSchema.ts` - Bet com Ã­ndices compostos (userId+status, eventId+status)

**Repositories:**
- `MongooseUserRepository` - implementa IUserRepository
- `MongooseWalletRepository` - implementa IWalletRepository
- `MongooseBetRepository` - implementa IBetRepository

**Configuration:**
- `config.ts` - helpers connectMongoDB(), disconnectMongoDB(), getMongoDBConfig()
- ConexÃ£o estabelecida em `src/server.ts` na inicializaÃ§Ã£o
- Graceful shutdown com handlers SIGINT/SIGTERM


**VariÃ¡veis de Ambiente:**
```env
USE_MONGOOSE_PERSISTENCE=true
MONGODB_URI=mongodb://localhost:27017
MONGODB_DB_NAME=backbet-dev
NODE_ENV=development
```

---

## Fluxo de IntegraÃ§Ã£o

### Fluxo 1: Registrar Novo UsuÃ¡rio
```
1. UserService.registerUser(email, username, currency)
   â”œâ”€ Valida email e username
   â”œâ”€ Cria User
   â””â”€ Cria Wallet (BRL por padrÃ£o ou currency especificada)

2. Ambos persistem em seus repositÃ³rios respectivos
3. Eventos: UserCreated, WalletCreated (para auditoria futura)
```

### Fluxo 2: Colocar Aposta
```
1. BetService.placeBet({ userId, eventId, marketId, oddId, amount })
   â”œâ”€ Valida se User exists e estÃ¡ ACTIVE
   â”œâ”€ Valida se Event estÃ¡ SCHEDULED
   â”œâ”€ Valida se Market estÃ¡ OPEN
   â”œâ”€ Consulta WalletService.withdraw(userId, amount)
   â”‚  â””â”€ WalletService verifica balance >= amount
   â”‚  â””â”€ Reduz balance (ou move para lockedBalance)
   â”œâ”€ Cria Bet com status PENDING
   â””â”€ Persiste Bet

2. Eventos: BetPlaced, FundsWithdrawn (para auditoria futura)
```

### Fluxo 3: Resolver Aposta
```
1. BetService.resolveBet({ betId, result })
   â”œâ”€ Localiza Bet
   â”œâ”€ Valida status PENDING
   â”œâ”€ Atualiza status (WON ou LOST)
   â”œâ”€ Se WON:
   â”‚  â””â”€ WalletService.deposit(userId, potentialReturn)
   â”‚     â””â”€ Aumenta balance
   â””â”€ Persiste resultado

2. Eventos: BetResolved, FundsDeposited (para auditoria futura)
```

---

## PadrÃµes de Design Utilizados

### 1. Domain-Driven Design (DDD)
- **Aggregate Roots**: User, Wallet, Bet, Event
- **Value Objects**: Email, Currency, Money, Odds, UniqueId
- **Bounded Contexts**: user, finance, betting cores
- **Ubiquitous Language**: termos consistentes em toda a aplicaÃ§Ã£o

### 2. Repository Pattern
- Interfaces genÃ©ricas para abstrair persistÃªncia
- MockÃ¡veis para testes
- Facilita troca de backend via Factory Pattern

### 3. Factory Pattern
- `createUserRepository()`, `createWalletRepository()`, `createBetRepository()`
- SeleÃ§Ã£o automÃ¡tica de implementaÃ§Ã£o via variÃ¡vel de ambiente
- Zero impacto no cÃ³digo de domÃ­nio

### 4. Service Layer
- Orquestra operaÃ§Ãµes de negÃ³cio
- Coordena entre repositÃ³rios
- Centraliza validaÃ§Ãµes

### 5. Value Objects
- ImutÃ¡veis
- Com validaÃ§Ãµes
- ReutilizÃ¡veis entre cores

### 6. Dependency Injection (via Factory)
- Cores nÃ£o sÃ£o acoplados (usado via interfaces)
- FÃ¡cil de testar com mocks
- Async factories para suportar imports dinÃ¢micos

---

## Status Atual da ImplementaÃ§Ã£o

### âœ… Completamente Implementado
- [x] Domain Models (User, Wallet, Bet, Event)
- [x] Value Objects (Email, Currency, Money, UniqueId, Odds)
- [x] Service Layer (UserService, WalletService, BetService)
- [x] Repository Interfaces (IUserRepository, IWalletRepository, IBetRepository)
- [x] In-Memory Repositories (para desenvolvimento e testes)
- [x] MongoDB/Mongoose Schemas (UserSchema, WalletSchema, BetSchema)
- [x] MongoDB/Mongoose Repositories (MongooseUserRepository, etc.)
- [x] Factory Pattern (createUserRepository, etc.)
- [x] Connection Management (connectMongoDB, disconnectMongoDB)
- [x] Graceful Shutdown Handlers (SIGINT/SIGTERM)
- [x] Testes UnitÃ¡rios (159 testes, 66.37% coverage geral)
- [x] GitHub Actions CI/CD (build, test, lint)
- [x] API REST com Express 5.1.0
- [x] ValidaÃ§Ã£o com Zod
- [x] DocumentaÃ§Ã£o Swagger/OpenAPI

### ğŸŸ¡ Em Progresso
- [ ] ExpansÃ£o de testes do Betting Core (~20% â†’ 100%)
- [ ] AutenticaÃ§Ã£o Clerk (validaÃ§Ã£o server-side)
- [ ] Rate limiting middleware
- [ ] Cache layer (Redis)

### ğŸ“‹ PrÃ³ximos Passos

1. **Eventos de DomÃ­nio**
   - `UserCreated`, `WalletCreated`
   - `BetPlaced`, `BetResolved`
   - `FundsDeposited`, `FundsWithdrawn`
   - Event Bus para propagaÃ§Ã£o

2. **Testes de IntegraÃ§Ã£o E2E**
   - Teste fluxos completos (user â†’ betting â†’ finance)
   - Teste transaÃ§Ãµes e rollback
   - Teste eventos de domÃ­nio

3. **Auditoria e Compliance**
   - Event Sourcing (registrar todas as operaÃ§Ãµes)
   - Logs estruturados
   - Rastreamento de transaÃ§Ãµes

4. **Performance e Escalabilidade**
   - Cache Redis para queries frequentes
   - Connection pooling MongoDB otimizado
   - Rate limiting por usuÃ¡rio
   - PaginaÃ§Ã£o em todas as listagens

---

## Estrutura de DiretÃ³rios

```
src/core/
â”œâ”€â”€ shared/                           # AbstraÃ§Ãµes e padrÃµes compartilhados
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â””â”€â”€ AggregateRoot.ts      # Base para todos os agregados
â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â””â”€â”€ IRepository.ts        # Interface genÃ©rica
â”‚   â”‚   â””â”€â”€ value-objects/
â”‚   â”‚       â”œâ”€â”€ UniqueId.ts           # ID Ãºnico
â”‚   â”‚       â””â”€â”€ Money.ts              # Valor monetÃ¡rio
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ domain.types.ts           # Tipos compartilhados
â”‚
â”œâ”€â”€ user/                             # DomÃ­nio de UsuÃ¡rios
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â””â”€â”€ User.ts
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ UserService.ts
â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â””â”€â”€ IUserRepository.ts
â”‚   â”‚   â””â”€â”€ value-objects/
â”‚   â”‚       â””â”€â”€ Email.ts
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ user.types.ts
â”‚
â”œâ”€â”€ finance/                          # DomÃ­nio Financeiro
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â””â”€â”€ Wallet.ts
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ IWalletService.ts
â”‚   â”‚   â”‚   â””â”€â”€ WalletService.ts
â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â””â”€â”€ IWalletRepository.ts
â”‚   â”‚   â””â”€â”€ value-objects/
â”‚   â”‚       â””â”€â”€ Currency.ts
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ wallet.types.ts
â”‚
â””â”€â”€ betting/                          # DomÃ­nio de Apostas
    â”œâ”€â”€ domain/
    â”‚   â”œâ”€â”€ entities/
    â”‚   â”‚   â”œâ”€â”€ Bet.ts
    â”‚   â”‚   â””â”€â”€ Event.ts
    â”‚   â”œâ”€â”€ services/
    â”‚   â”‚   â””â”€â”€ BetService.ts
    â”‚   â”œâ”€â”€ repositories/
    â”‚   â”‚   â”œâ”€â”€ IBetRepository.ts
    â”‚   â”‚   â””â”€â”€ IEventRepository.ts
    â”‚   â””â”€â”€ value-objects/
    â”‚       â”œâ”€â”€ Odds.ts
    â”‚       â””â”€â”€ BetAmount.ts
    â””â”€â”€ types/
        â””â”€â”€ bet.types.ts
```

---

## ConclusÃ£o

A arquitetura Ã© **modular, testÃ¡vel e escalÃ¡vel**:
- Cada core Ã© independente e pode ser testado isoladamente
- AbstraÃ§Ãµes em `shared` evitam duplicaÃ§Ã£o
- IntegraÃ§Ã£o via interfaces bem definidas
- Preparada para crescimento e novas features
