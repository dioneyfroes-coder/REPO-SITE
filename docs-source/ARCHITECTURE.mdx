---
title: "Arquitetura BackBet"
description: "Visão detalhada das camadas, bounded contexts e infraestrutura operacional do BackBet."
slug: "/docs/architecture"
---

# Arquitetura BackBet

O BackBet é um monólito modular escrito em TypeScript/Node 20 que aplica princípios de **DDD**, **ports & adapters** e **observabilidade nativa**. Todo o código vive em `src/` e é separado em camadas coerentes:

1. **Interface / API (`src/infrastructure/api`)** – Express 5, controllers, DTOs e middlewares.
2. **Aplicação (`src/core/**/application`)** – use cases e serviços orquestradores que conversam por interfaces.
3. **Domínio (`src/core/**/domain`)** – entidades, value objects e regras puras.
4. **Infraestrutura (`src/infrastructure/*`)** – persistência, cache, autenticação, observabilidade e config.
5. **Shared (`src/shared`)** – erros, configs, request context e utilidades reutilizadas.

A seguir detalhamos cada área funcional e as decisões de engenharia que sustentam o projeto.

## Visão Geral dos Bounded Contexts

| Contexto | Diretório | Responsabilidades chave | Principais agregados |
|----------|-----------|-------------------------|----------------------|
| User Core | `src/core/user` | Cadastro, autenticação local, sincronização com Clerk, atualização de perfil e e-mail. | `User`, `Email` VO |
| Finance Core | `src/core/finance` | Carteiras, depósitos/saques, pacotes de crédito e workflow de solicitações de saque (locks/unlock). | `Wallet`, `Money`, `Currency` |
| Betting Core | `src/core/betting` | Eventos, odds, colocação/cancelamento/resolução de apostas. | `Bet`, `Event`, `BetAmount`, `Odds` |
| Shared Kernel | `src/core/shared` | `AggregateRoot`, `UniqueId`, `Result`, `DomainError`, DTOs paginados e contratos genéricos. | - |

Cada contexto expõe interfaces (`IUserRepository`, `IWalletRepository`, `IBetRepository`, etc.) consumidas pela camada de aplicação. Implementações concretas são providas por factories que escolhem entre MongoDB/Mongoose e stores in-memory, permitindo testes rápidos e produção durável.

## Camadas em Detalhe

### 1. API Layer (`src/infrastructure/api`)
- **`ApiServer.ts`** monta Express 5 com `helmet`, CORS dinâmico, `express-rate-limit`, parsers, Swagger UI (`/api/docs`) e endpoints de saúde/metrics.
- Middlewares próprios: `requestIdMiddleware`, `loggingMiddleware`, métricas Prometheus e handlers de erro padronizados.
- Autenticação:
  - Produção: Clerk (`@clerk/express` + `requireAuth`).
  - Dev/Test: bypass opcional (`ALLOW_DEV_BEARER_BYPASS`) que aceita `Authorization: Bearer <userId>` sem JWT.
- Rotas residem em `routes/*.ts` e importam controllers do respectivo módulo (`controllers/*Controller.ts`). Todas são registradas via `createApiRouter` no `server.ts` por prefixos: `/auth`, `/users`, `/wallets`, `/finance`, `/bets`.

### 2. Application Layer
- Use cases ficam em `src/core/<context>/application/use-cases`. Ex: `RegisterUser`, `UpdateProfile`, `DepositFunds`, `PlaceBet`.
- Cada caso injeta repositórios + serviços via construtor (DI manual) e retorna `Result<T>` para padronizar sucesso/erro.
- Hooks de cache (`cacheUserProfile`, `cacheWalletBalance`, etc.) são chamados aqui para manter o domínio puro.

### 3. Domain Layer
- Entidades estendem `AggregateRoot` e expõem métodos para mutações válidas (`Wallet.lockFunds`, `Bet.cancel`).
- Value Objects encapsulam validações (`Email`, `Money`, `BetAmount`, `Odds`).
- Erros de domínio herdam de `DomainError`, permitindo tradução direta para `AppError` na camada API.

### 4. Infraestrutura
- **Persistência (`src/infrastructure/persistence`)**: factories (`factory.ts`) escolhem Mongoose (`persistence/mongoose/*`) ou adaptadores in-memory.
- **Cache (`src/infrastructure/cache`)**: `RedisClient` (ioredis), métricas internas e hooks declarativos. TTLs configurados em `shared/config/cacheConfig.ts`.
- **Autenticação (`src/infrastructure/auth`)**: `JwtService`, helpers Clerk e middlewares complementares.
- **Observabilidade (`src/infrastructure/observability`)**: métricas Prometheus (`metrics.ts`) e tracing OpenTelemetry (`tracing.ts`).
- **Config (`src/shared/config/*.ts`)**: single source of truth para envs, rate limit, CORS, security, cache e OTLP.

### 5. Shared Layer (`src/shared`)
- `errors/AppError`, `observability/requestContext`, helpers de logging e tipos comuns.
- Config loaders (`env.ts`, `appConfig.ts`, `cacheConfig.ts`, `observabilityConfig.ts`).

## Fluxo de Requisição

1. **Entrada HTTP** – `ApiServer` aplica middlewares (helmet, CORS, rate-limit, request-id, logging, metrics).
2. **Autenticação** – Clerk ou bypass preenche `req.auth.userId`; rotas críticas usam `protectedRoute` para validar token.
3. **Controller/DTO** – Envelopes `BaseController` + Zod validam input e produzem resposta uniforme.
4. **Use Case** – Execução de `RegisterUser`, `DepositFunds`, `PlaceBet`, etc., orquestrando domínios e cache.
5. **Repositórios** – Factories resolvem `create<User|Wallet|Bet>Repository()` e tocam Mongo ou memória.
6. **Cache / Side effects** – Hooks Redis atualizam perfis, saldos, odds. Eventos (log/tracing) são emitidos.
7. **Resposta** – Controller traduz `Result` para o envelope JSON com `success`, `data/error`, `meta` (timestamp + `requestId`).

## Persistência e Repositórios

| Recurso | Interface | Implementações | Observações |
|---------|-----------|----------------|-------------|
| Usuários | `IUserRepository` | `MongooseUserRepository`, `UserRepository` (in-memory) | Índices únicos em email/username; sincroniza Clerk IDs. |
| Carteiras | `IWalletRepository` | `MongooseWalletRepository`, `WalletRepository` | Histórico embutido e locks de saque. |
| Apostas/Eventos | `IBetRepository`, `IEventRepository` | `MongooseBetRepository`, `BetRepository`, `EventRepository` | Índices por `status`/`userId`/`eventId`. |
| Pacotes de crédito | `ICreditPackageRepository` | `MongooseCreditPackageRepository`, `CreditPackageRepository` | Mantém catálogos com tiers, bônus e ativos/inativos. |
| Solicitações de saque | `IWithdrawalRequestRepository` | `MongooseWithdrawalRequestRepository`, `WithdrawalRequestRepository` | Controla lifecycle (`PENDING`, `APPROVED`, `REJECTED`) com logs de aprovação. |

Factories `create<User|Wallet|Bet|Event>Repository()` leem `USE_MONGOOSE_PERSISTENCE`. Em produção, `server.ts` garante `connectMongoDB()` antes de montar o `ApiServer` e registra handlers de shutdown para `disconnectMongoDB()` e `redisClient.quit()`.

## Cache, Rate Limiting e Confiabilidade

- **Cache Redis**: habilitado via `CACHE_ENABLED`. Hook especiais:
  - `cacheUserProfileMiddleware`, `cacheWalletBalanceMiddleware`, `cacheWalletHistoryMiddleware`, `cacheEventOddsMiddleware`.
  - Flush helpers após mutações (`flushWalletCache`, `flushEventOddsCache`).
- **Rate limiting**:
  - Global (`express-rate-limit`) configurável por `RATE_LIMIT_*`.
  - Por rota via `createRouteRateLimiter` com variáveis dedicadas (`AUTH_*_RATE_LIMIT_*`, `WALLET_*_RATE_LIMIT_*`, `BET_*_*`).
- **Request Context**: `AsyncLocalStorage` propaga `requestId/userId` para logs, métricas e handlers de erro.
- **Health/Readiness**: `/health`, `/readiness`, `/health/cache` e `/metrics` expostos pelo `ApiServer`. Gauges `backbet_dependency_health{dependency="redis|mongo"}` sinalizam status.

## Observabilidade

- **Métricas**: `httpRequestCounter`, `httpRequestLatency`, `httpActiveRequests`, contadores de erros, métricas de cache e dependências expostas no endpoint `/metrics`.
- **Tracing**: `src/infrastructure/observability/tracing.ts` inicializa OpenTelemetry (Express, Mongoose, ioredis instrumentations) quando `TRACING_ENABLED=true`.
- **Logging estruturado**: middleware escreve JSON com `request_start`, `request_end` e `request_error`, sempre incluindo `requestId`, método, rota e duração.

## Fluxos Críticos

### Registro de Usuário + Carteira
```
POST /api/auth/register
→ AuthController valida DTO (Zod) e chama RegisterUser use case
→ UserService cria User (Email VO) e persiste via IUserRepository
→ WalletService cria Wallet padrão (BRL) e persiste via IWalletRepository
→ Cache invalida perfil/carteira e resposta inclui ambos os agregados
```

### Depósito / Saque
```
POST /api/wallets/deposit | withdraw
→ WalletController verifica rate limit específico e autenticação
→ WalletService.deposit/withdraw usa Value Objects Money/Currency
→ Persistência atualiza histórico + locks
→ cacheWalletBalance/cacheWalletHistory são atualizados
```

### Colocar/Cancelar Aposta
```
POST /api/bets
→ BetController chama PlaceBet use case
→ BetService valida usuário ativo, mercado aberto e odds
→ WalletService.withdraw bloqueia fundos
→ BetRepository persiste Bet PENDING; cache de odds é consultado
→ Cancelamentos chamam WalletService.deposit para reversão
```

## Segurança

- Autenticação: Clerk (produção) ou JWT/bypass dev.
- Autorização: `protectedRoute` + guardas adicionais (ex.: aprovação de withdraw).
- Segurança HTTP: `helmet`, CORS com allowlist, HSTS opcional, `x-request-id` obrigatório.
- Configurações sensíveis carregadas por `shared/config/env.ts`, mantendo secrets fora do código.

## Estrutura de Diretórios (resumo)

```
src/
├── core/
│   ├── shared/
│   ├── user/
│   │   ├── domain/
│   │   └── application/use-cases/
│   ├── finance/
│   └── betting/
├── infrastructure/
│   ├── api/
│   ├── auth/
│   ├── cache/
│   ├── observability/
│   ├── persistence/
│   └── config/
├── shared/
├── index.ts
├── server.ts
└── integration/
```

## Roadmap Arquitetural

1. **Eventos de domínio/Outbox** – formalizar `UserCreated`, `BetPlaced`, `FundsWithdrawn` e publicar para integrações futuras.
2. **Persistência única (Mongo)** – remover fallback in-memory em produção e habilitar migrações automáticas.
3. **Feature Flags** – mover toggles críticos (bypass auth, cache) para um provider dedicado.
4. **Escala Horizontal** – preparar `ApiServer` para múltiplas instâncias atrás de um ingress e externalizar sessões Clerk.
5. **Observabilidade avançada** – dashboards oficiais + alertas para `httpRequestLatency` e `dependencyHealthGauge`.

---

**Última atualização:** 23 de novembro de 2025
