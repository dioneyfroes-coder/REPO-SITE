---
title: "Core Finance"
description: "Documentação do núcleo financeiro: Wallet, serviços e repositórios."
slug: "/docs/finance"
---

# Core Finance - Documentação

Esta documentação descreve o núcleo financeiro (core/finance) da aplicação: carteira do usuário, serviços relacionados a depósito/saque, value-objects, repositórios e contratos.

## Visão Geral

O core financeiro é responsável por tudo que envolve saldo do usuário: criação de carteiras, depósitos, saques, bloqueio de valores (reservas) e transformações para persistência (DTOs). Ele é projetado para ser independente, testável e consumido por outros domínios (por exemplo, betting).

## Conceitos e Entidades

- Wallet (Carteira): representa o saldo disponível de um usuário, saldo bloqueado (reservas) e a moeda.
	- Campos principais:
		- userId: string
		- balance: number
		- lockedBalance: number
		- currency: string (ex.: BRL, USD, EUR)

## Value Objects

- CurrencyValueObject
	- Tipo suportado: `'BRL' | 'USD' | 'EUR'`.
	- Responsável por validar códigos de moeda.

## Tipos / DTOs

- `IWalletDTO`
	- Forma serializável da `Wallet` para persistência / redes.

- `ICreateWalletDTO`
	- Payload para criar uma carteira: `{ userId: string; currency: string }`.

Os tipos vivem em `src/core/finance/types/wallet.types.ts`.

## Repositórios (contratos)

- `IWalletRepository` (em `src/core/finance/domain/repositories/IWalletRepository.ts`)
	- Responsabilidades:
		- `findByUserId(userId: string): Promise`
		- `save(wallet: Wallet): Promise`
		- `update(wallet: Wallet): Promise`
		- `delete(userId: string): Promise`

Implementações concretas (DB, in-memory, Redis) devem implementar esta interface.

## Serviços

- `WalletService` (em `src/core/finance/domain/services/WalletService.ts`)
	- Métodos:
		- `createWallet(input: ICreateWalletDTO): Promise` - cria carteira para usuário (valida existência e moeda)
		- `deposit(userId: string, amount: number): Promise` - realiza depósito (valida carteira e valor)
		- `withdraw(userId: string, amount: number): Promise` - realiza saque (valida saldo suficiente)

O serviço é intencionalmente pequeno e delega persistência para o repositório.

## Entidade Wallet (detalhes)

- `deposit(amount: number)` → adiciona ao saldo. Valida `amount > 0`.
- `withdraw(amount: number)` → subtrai do saldo. Valida fundos suficientes.
- `lock(amount: number)` → move do `balance` para `lockedBalance` (usar em reservas para apostas/ordens).
- `unlock(amount: number)` → reverte `lock`.
- `toDTO()` → converte para `IWalletDTO`.

## Integração com outros domínios

- O `BetService` (domínio de apostas) consome o `IWalletService` para debitar reservas quando uma aposta é colocada e creditar ganhos na resolução.
- Contratos claros (`IWalletService`, `IWalletRepository`) permitem testar e mockar o comportamento nas camadas superiores.

## Exemplo de uso (Fluxo simplificado)

1. Usuário solicita `createWallet({ userId, currency })` → `WalletService` valida e persiste via `IWalletRepository`.
2. Usuário pede `deposit(userId, amount)` → `WalletService` carrega carteira, chama `deposit()` e `update()`.
3. Ao colocar uma aposta, `BetService` chama `walletService.withdraw(userId, stake)` para reservar o valor.
4. Ao resolver a aposta, `BetService` chama `walletService.deposit(userId, payout)` caso o usuário ganhe.

## Observações de design e boas práticas

- Separar contratos (interfaces) das implementações facilita testes e troca de backend (por exemplo, trocar in-memory por TypeORM).
- Toda lógica que altera estado da carteira (balance / lockedBalance) fica dentro da entidade `Wallet` para centralizar validações.
- O serviço (`WalletService`) é responsável por orquestrar validações de alto nível e persistência.

## Como testar

- Testes unitários das entidades (`Wallet`) e value-objects (`CurrencyValueObject`) devem cobrir cenários de borda: depósitos negativos, saques maiores que o saldo, lock/unlock inconsistentes.
- Testes do `WalletService` devem mockar `IWalletRepository` e validar chamadas a `save`/`update` e lançamentos de erro.

## Próximos passos sugeridos

1. Implementar adaptadores de persistência: um repositório em memória para teste e um adaptador com banco (TypeORM ou Prisma).
2. Adicionar eventos de domínio para operações críticas (ex.: `WalletCredited`, `WalletDebited`).
3. Implementar limites anti-fraude e validações de compliance quando necessário.

---

Arquivo fonte do core financeiro:

- `src/core/finance/domain/entities/Wallet.ts` - entidade principal
- `src/core/finance/domain/services/WalletService.ts` - service
- `src/core/finance/domain/repositories/IWalletRepository.ts` - contrato persistência
- `src/core/finance/domain/value-objects/Currency.ts` - value-object de moeda
- `src/core/finance/types/wallet.types.ts` - DTOs e tipos
