---
title: "MongoDB Configuração"
description: "Guia de configuração do MongoDB local e Atlas para BackBet."
slug: "/docs/mongodb-setup"
---

# MongoDB Setup Guide

> O MongoDB é opcional em desenvolvimento, porém obrigatório para ambientes que exigem persistência durável. Este guia explica como habilitar/desabilitar o Mongoose, configurar ambientes locais/Atlas e diagnosticar falhas.

## Quando habilitar Mongo?

- **DEV rápido / testes unitários**: mantenha `USE_MONGOOSE_PERSISTENCE=false` para usar os repositórios in-memory (resetam a cada boot, CI fica mais leve).
- **Homologação/produção**: defina `USE_MONGOOSE_PERSISTENCE=true` e providencie um Mongo real. O `server.ts` chamará `connectMongoDB()` antes de subir o Express e registrará handlers de shutdown para `disconnectMongoDB()`.
- **Testes automatizados que precisam de banco**: use containers (Docker/Compose) ou Atlas M0 e exponha `MONGODB_URI` durante o job.

## Variáveis essenciais

| Variável | Obrigatória quando | Exemplo | Observações |
| --- | --- | --- | --- |
| `USE_MONGOOSE_PERSISTENCE` | Sempre | `true` / `false` | Escolhe entre repositórios Mongo ou memória. |
| `MONGODB_URI` | `USE_MONGOOSE_PERSISTENCE=true` ou `NODE_ENV=production` | `mongodb://localhost:27017/backbet-dev` | Pode incluir parâmetros (`retryWrites=true&w=majority`). |
| `MONGODB_DB_NAME` | `USE_MONGOOSE_PERSISTENCE=true` | `backbet-dev` | Default: `backbet-dev`. Em Atlas use `backbet-prod`. |
| `NODE_ENV` | Sempre | `development` | Em `production` o loader falha se `MONGODB_URI` estiver vazio. |

> Alguns documentos antigos citam `MONGO_URL`; padronizamos `MONGODB_URI`. Se ambos estiverem presentes, priorize `MONGODB_URI`.

## Passo a passo para habilitar

1. Ajuste `.env`:
   ```properties
   USE_MONGOOSE_PERSISTENCE=true
   MONGODB_URI=mongodb://localhost:27017/backbet-dev
   MONGODB_DB_NAME=backbet-dev
   ```
2. Reinicie o servidor (`npm run dev`). O log deverá mostrar `✓ MongoDB connected to backbet-dev` antes do banner Express.
3. Bata em `/readiness`: a resposta terá `checks.mongo.status: "up"` e o gauge `backbet_dependency_health{dependency="mongo"}` passa para `1`.
4. Se quiser voltar ao modo in-memory, defina `USE_MONGOOSE_PERSISTENCE=false` e opcionalmente remova `MONGODB_URI`.

## Opções de provisionamento

### Mongo local via Docker (mais rápido)

```bash
docker run -d --name backbet-mongo \
  -p 27017:27017 \
  -e MONGO_INITDB_DATABASE=backbet-dev \
  mongo:7.0

export USE_MONGOOSE_PERSISTENCE=true
export MONGODB_URI="mongodb://localhost:27017/backbet-dev"
npm run dev
```

Para persistir dados use um volume: `-v ./data/mongo:/data/db`.

### MongoDB Community (instalação nativa)

| SO | Comando |
| --- | --- |
| macOS (Homebrew) | `brew install mongodb-community && brew services start mongodb-community` |
| Linux (Debian/Ubuntu) | Siga a [documentação oficial](https://www.mongodb.com/docs/manual/administration/install-on-linux/) e habilite o serviço `mongod`. |
| Windows | Instale o MSI oficial e execute `"C:\\Program Files\\MongoDB\\Server\\7.0\\bin\\mongod.exe" --dbpath C:\\data\\db`. |

### MongoDB Atlas (staging/prod)

1. Crie um projeto e um cluster (tier M10+ para produção, M0 serve para POCs).
2. Em **Security → Database Access**, gere um usuário restrito ao database (`backbet-prod`).
3. Em **Network Access**, autorize o IP fixo do servidor ou configure um VPC/peering.
4. Copie a connection string (`mongodb+srv://<user>:<pass>@cluster.../backbet-prod?retryWrites=true&w=majority`).
5. Atualize o `.env` e mantenha TLS (já incluso no `mongodb+srv`).
6. Configure backups automáticos no Atlas (Snapshots + PITR se disponível).

## Verificando a conexão

```ts
import { connectMongoDB, getMongoDBConfig } from '@/infrastructure/persistence/mongoose/config';

async function smoke() {
  const cfg = getMongoDBConfig();
  await connectMongoDB(cfg);
  console.log('✓ Mongo conectado');
}
```

- `npm run test -- observabilityEndpoints` valida `/readiness` e garante que o ping do Mongo responde.
- `mongosh "${MONGODB_URI}" --eval 'db.stats()'` é útil para validar o usuário e a conectividade sem rodar o app.

## Índices e migrações

- Os schemas Mongoose em `src/infrastructure/persistence/mongoose/schemas` declaram índices (`unique`, TTLs etc.). Ao conectar, o Mongoose sincroniza automaticamente (`Model.syncIndexes()` implícito).
- Para conferir manualmente:
  ```bash
  mongosh "${MONGODB_URI}"
  > db.users.getIndexes()
  > db.wallets.getIndexes()
  > db.bets.getIndexes()
  ```
- Mudanças estruturais relevantes devem vir acompanhadas de migrações (scripts `mongosh` ou `migrate-mongo`) e registro no changelog.

## Backup & restore rápidos

```bash
# Dump local
mongodump --uri "$MONGODB_URI" --out ./backups/$(date +%Y%m%d)

# Restore em outra instância
mongorestore --uri "mongodb://localhost:27017/backbet-restored" ./backups/20251123
```

- No Atlas, habilite Continuous Backup e defina alertas para falhas em snapshots.
- Armazene dumps sensíveis em buckets privados; nunca commite arquivos `.bson`.

## Troubleshooting

| Sintoma | Análise | Correção |
| --- | --- | --- |
| `ECONNREFUSED 127.0.0.1:27017` | Serviço Mongo parado ou porta bloqueada | `docker start backbet-mongo` ou `brew services start mongodb-community` |
| `MongoServerSelectionError: authentication failed` | Usuário/senha inválidos na URI | Recrie credenciais no Atlas e escape caracteres especiais (`@` → `%40`). |
| `/readiness` marca `mongo` como `down` | Ping falhou ou `USE_MONGOOSE_PERSISTENCE=false` | Verifique `USE_MONGOOSE_PERSISTENCE`, logs `readiness_dependency` e conectividade de rede. |
| `Topology was destroyed` após deploy | Conexão caiu sem retry | Certifique-se de que `retryWrites=true` e que a rede permite TCP keep-alive; reinicie `npm run dev`. |
| Connection pool saturado | `maxPoolSize` baixo ou queries lentas | Ajuste `?maxPoolSize=50` e monitore `backbet_dependency_latency_ms`. |

## Boas práticas

1. Sempre propague `USE_MONGOOSE_PERSISTENCE` + `MONGODB_URI` pelos ambientes (Docker Compose, pipelines CI, Helm chart).
2. Use usuários distintos para leitura/escrita em produção (princípio do menor privilégio).
3. Configure alertas de disco/latência no Atlas ou no provedor gerenciado.
4. Não exponha o cluster a `0.0.0.0/0` em produção; prefira VPC peering ou VPN.
5. Documente qualquer alteração de schema e sincronize com `docs/MONGOOSE_REPOSITORIES.mdx`.

## Próximos passos

1. Automatizar um script `npm run mongo:status` que testa `connectMongoDB()` isoladamente.
2. Adicionar fixtures/migrations iniciais para ambientes de staging (usuário seed, carteira com saldo).
3. Integrar backups com o pipeline (ex.: upload diário para S3 + retenção).

## Referências úteis

- [MongoDB Manual](https://www.mongodb.com/docs/manual/)
- [Atlas Quickstart](https://www.mongodb.com/docs/atlas/getting-started/)
- [Mongoose Docs](https://mongoosejs.com/docs/guide.html)
