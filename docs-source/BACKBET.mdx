---
title: "Projeto BackBet"
description: "Panorama do produto, núcleos de domínio e requisitos operacionais do BackBet."
slug: "/docs/backbet/overview"
---

# BackBet – Visão Geral

BackBet é um backend de apostas desportivas construído em **TypeScript/Node 20**, seguindo **DDD**, camadas limpas e observabilidade nativa. Todos os módulos vivem em `src/` e são expostos via Express 5, com autenticação Clerk/JWT, cache Redis, persistência Mongo opcional e métricas/tracing prontos para produção.

## Stack e princípios

- **Linguagem/Runtime**: TypeScript 5.9 + Node 20 (`ts-node`/`tsx` em dev, `tsc` + `tsc-alias` para build)
- **Arquitetura**: Monólito modular (API ▸ application ▸ domain ▸ infrastructure ▸ shared)
- **Padrões**: DDD, Result pattern, repositories async, factories para troca de adapters
- **Qualidade**: ESLint flat config, Jest + SWC, 350 testes (97% cobertura), CI local `npm run lint && npm run test --coverage && npm run build`
- **Observabilidade**: Prometheus (`/metrics`), health/readiness endpoints, request-id + logs JSON, OpenTelemetry opcional

## Bounded contexts

| Contexto | Diretório | Responsabilidades | Principais artefatos |
|----------|-----------|-------------------|----------------------|
| **User Core** | `src/core/user` | Registro, autenticação local, sincronização com Clerk, atualização de perfil/email. | `User`, `Email`, `RegisterUser`, `AuthController`, `UserController` |
| **Finance Core** | `src/core/finance` | Carteiras, depósitos/saques, pacotes de crédito, workflow de withdrawal locks. | `Wallet`, `Money`, `WalletService`, `WithdrawalRequestService` |
| **Betting Core** | `src/core/betting` | Eventos, odds, colocação/cancelamento/resolução de apostas. | `Bet`, `Event`, `PlaceBet`, `BetController` |
| **Shared Kernel** | `src/core/shared` | `AggregateRoot`, `UniqueId`, `Result`, `DomainError`, DTOs paginados, tipos comuns. | - |

Interfaces (`IUserRepository`, `IWalletRepository`, `IBetRepository`, etc.) isolam o domínio; factories em `src/infrastructure/persistence/factory.ts` escolhem entre adaptadores in-memory e Mongo/Mongoose.

## Fluxo ponta a ponta

1. Request chega ao `ApiServer` → middlewares aplicam helmet, CORS, rate limit, request-id, logging e métricas.
2. Autenticação via Clerk (produção) ou bypass/JWT (`JwtService`) em dev/test; rotas sensíveis reutilizam `protectedRoute` + guards adicionais.
3. Controllers (auth, users, wallets, finance, bets) validam DTOs Zod e delegam para use cases (`src/core/**/application/use-cases`).
4. Use cases conversam com serviços de domínio (`UserService`, `WalletService`, `BetService`) e repositórios resolvidos via factory.
5. Cache Redis e hooks (`cacheUserProfile`, `cacheWalletBalance`, `cacheEventOdds`, etc.) reduzem IO e são invalidados após mutações.
6. Respostas seguem envelope padrão `{ success, data|error, meta: { requestId, timestamp } }`, garantindo rastreabilidade com logs/traces.

## Camadas principais

- **API (`src/infrastructure/api`)**: `ApiServer`, controllers, DTOs, middlewares (`metricsMiddleware`, `loggingMiddleware`, `requestIdMiddleware`), Swagger (`/api/docs`).
- **Application**: Use cases por contexto (`RegisterUser`, `DepositFunds`, `PlaceBet`, `ChangeEmail`, etc.), com Result pattern.
- **Domínio**: Entidades/VOs puros (`User`, `Wallet`, `Bet`, `Money`, `Email`, `Odds`), regras e invariantes.
- **Infraestrutura**: Persistência (Mongo/in-memory), cache Redis, auth (Clerk/JWT), observabilidade (metrics/tracing), config loaders.
- **Shared**: `AppError`, `requestContext`, configs centralizadas (`appConfig`, `cacheConfig`, `observabilityConfig`).

## Infraestrutura e dependências

| Componente | Estado | Detalhes |
|------------|--------|----------|
| **MongoDB / Mongoose** | Opcional em dev, recomendado em staging/prod | Ativado com `USE_MONGOOSE_PERSISTENCE=true`; schemas em `src/infrastructure/persistence/mongoose/schemas`. `connectMongoDB()` é chamado antes do `ApiServer`. |
| **Redis** | Opcional em dev, recomendado em produção | Config em `shared/config/cacheConfig.ts`. `RedisClient` expõe métricas e flush helpers para manter consistência. |
| **Clerk** | Obrigatório em produção | Middleware `@clerk/express`. Dev/test podem usar bypass definindo `ALLOW_DEV_BEARER_BYPASS=true`. |
| **JWT local** | Usado nos endpoints `/auth/login` & `/auth/refresh` | `JwtService` gera/valida tokens; útil para testes E2E sem Clerk. |
| **Observabilidade** | Default ON | `/health`, `/health/cache`, `/readiness`, `/metrics` e tracing (`TRACING_ENABLED`) com exportador OTLP configurável. |

## APIs e contratos

- Swagger UI em `/api/docs` + JSON em `/api/docs.json` (`docs/openapi.json`).
- Documentação textual em `docs/API_DOCS.mdx` e `docs/OBSERVABILITY.mdx`.
- Controllers seguem `BaseController` e `asyncHandler`, retornando envelopes padronizados e códigos `AppError` (ex.: `RATE_LIMIT_EXCEEDED`, `VALIDATION_ERROR`).
- Rate limits globais (`appConfig.rateLimit`) e específicos (`AUTH_*_RATE_LIMIT_*`, `WALLET_*_RATE_LIMIT_*`, `BET_*_RATE_LIMIT_*`).

## Execução local

1. `cp .env.example .env`
2. Ajustar variáveis: `NODE_ENV=development`, `CACHE_ENABLED=false` (caso sem Redis), `USE_MONGOOSE_PERSISTENCE=false` (para in-memory) ou definir `MONGODB_URI`.
3. `npm install`
4. `npm run dev` (hot reload com `tsx`)
5. Exercitar rotas (`curl`, Postman, Swagger) e consultar métricas/health endpoints.

### Pipelines úteis

- `npm run lint`
- `npm run test --coverage`
- `npm run build`
- `npm start` (executa `dist/index.js`)

## Qualidade e operação

- 350 testes Jest (unidade + integração leve) — statements 97.79%, branches 87.19%, functions 97.99%, lines 97.96%.
- Logs estruturados JSON com `request_start`, `request_end` e `request_error` (incluem requestId, userId, duração).
- Métricas chave: `backbet_http_requests_total`, `backbet_http_request_duration_ms_bucket`, `backbet_dependency_health`, métricas Redis custom (`hits`, `misses`, `errors`).
- Dashboards/alertas versionados em `reports/phase4/*` (Grafana/Prometheus) + scripts k6/Artillery planejados.

## Documentação relacionada

- `docs/ARCHITECTURE.mdx` – detalhes das camadas e integrações.
- `docs/API_DOCS.mdx` – referência completa de endpoints.
- `docs/OBSERVABILITY.mdx` – métricas, tracing e dashboards.
- `docs/CLERK_SETUP.mdx`, `docs/MONGODB_SETUP.mdx`, `docs/LOGS.mdx` – guias operacionais.
- `docs/QUICKSTART.mdx` – passo a passo para levantar dependências locais.

## Roadmap (Nov/2025)

| Horizonte | Itens |
|-----------|-------|
| ✅ Concluído | Integração Clerk/JWT consolidada, cache Redis com métricas, docs Bet/User/Finance/Observability/API atualizados. |
| Curto prazo | Automatizar lint/test/build em CI, adicionar testes de carga e segurança básicos, publicar playbooks de incidentes. |
| Médio prazo | Instrumentar tracing OTEL em staging, remover fallback in-memory em produção, formalizar eventos/outbox (`UserCreated`, `BetPlaced`, `FundsWithdrawn`). |
| Pré-produção | Security review completa, testes de performance/stress automatizados, alertas Prometheus → Slack/PagerDuty, checklist de rollout/rollback. |

---

**Versão atual:** 0.1.0 (pre-alpha)  
**Última atualização:** 23 de novembro de 2025
